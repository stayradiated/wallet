workflows:
  react-native-ios:
    name: React Native iOS
    max_build_duration: 120
    instance_type: mac_mini

    environment:
      vars:
        XCODE_WORKSPACE: "YOUR_WORKSPACE_NAME.xcworkspace"
        XCODE_SCHEME: "YOUR_SCHEME_NAME"
        FCI_CERTIFICATE: Encrypted(...)
        FCI_CERTIFICATE_PASSWORD: Encrypted(...)
        FCI_PROVISIONING_PROFILE: Encrypted(...)
      node: latest
      xcode: latest
      cocoapods: default

    scripts:
      - name: Install npm dependencies
        script: |
                    npm install
      - name: Install CocoaPods dependencies
        script: |
                    cd ios && pod install
      - name: Set up keychain to be used for code signing using Codemagic CLI 'keychain' command
        script: |
                    keychain initialize
      - name: Set up Provisioning profiles from environment variables
        script: |
                    PROFILES_HOME="$HOME/Library/MobileDevice/Provisioning Profiles"
                    mkdir -p "$PROFILES_HOME"
                    PROFILE_PATH="$(mktemp "$PROFILES_HOME"/$(uuidgen).mobileprovision)"
                    echo ${FCI_PROVISIONING_PROFILE} | base64 --decode > "$PROFILE_PATH"
                    echo "Saved provisioning profile $PROFILE_PATH"      
      - name: Set up signing certificate
        script: |
                    echo $FCI_CERTIFICATE | base64 --decode > /tmp/certificate.p12
                    if [ -z ${FCI_CERTIFICATE_PASSWORD+x} ]; then
                      # when using a certificate that is not password-protected
                      keychain add-certificates --certificate /tmp/certificate.p12
                    else
                      # when using a password-protected certificate
                      keychain add-certificates --certificate /tmp/certificate.p12 --certificate-password $FCI_CERTIFICATE_PASSWORD
                    fi      
      - name: Set up code signing settings on Xcode project
        script: |
                    xcode-project use-profiles
      - name: Build ipa for distribution
        script: |
                    xcode-project build-ipa --workspace "$FCI_BUILD_DIR/ios/$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME" 

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM

    publishing:
      # See the following link for details about email publishing - https://docs.codemagic.io/publishing-yaml/distribution/#email
      email:
        recipients:
          - codemagic@stayradiated.com
        notify:
          success: true
          failure: false
